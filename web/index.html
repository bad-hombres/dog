<!DOCTYPE html>
<html>
<head>
  <title>tornado WebSocket example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
</head>
<body>
  <div class="container"> 

    <h1>Dog Console</h1>
    <hr/>
      WebSocket status : <span id="message"></span>
    <hr/>    

    <h3>Projects</h3>
    <ul class="nav nav-pills" id="projects">
    </ul>

    <div class="row">
    <div class="col-md-4">
      <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
      </div>
    </div>

    <div class="col-md-8>">
      <div class="tab-content" id="v-pills-tabContent">
        <div class="tab-pane fade show active" id="v-pills-content"
          style="height: 250px; overflow: auto; padding-right:
          20px;" role="tabpanel">
          <ul id="table-items">

          </ul>
        </div>
      </div>
    </div>
    </div>

    <h3>Logs</h3>
    <pre id="logs" class="pre-scrollable border border-dark bg-light">
    </pre>

  </div>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
  <script>
    var host = window.location.host;
    var ws = new WebSocket('ws://'+host+'/ws');
    var $message = $('#message');

    ws.onopen = function(){
      $message.attr("class", 'badge badge-success');
      $message.text('open');
    };

    ws.onmessage = function(ev){
      $message.attr("class", 'badge badge-info');
      $message.fadeIn("slow");
      $message.text('recieved message');
      var log = $('#logs');
      log.append(ev.data + "\n");
      log.scrollTop(log.prop("scrollHeight"));
    };
    ws.onclose = function(ev){
      $message.attr("class", 'badge badge-important');
      $message.text('closed');
    };
    ws.onerror = function(ev){
      $message.attr("class", 'badge badge-warning');
      $message.text('error occurred');
    };

    $.getJSON("/api?id=projects", function(data){
      $.each(data["response"], function(i, e) {
        $('#projects').append("<li class='dog-project-parent nav-item'><a data-project='" + e + "' class='dog-project nav-link' href='#'>" + e + "</a></li>")
      });
      setupClickHandlers();
    });

    function setupClickHandlers() {
      $('.dog-project').click(function() {
        var elm = $(this);
        $('.dog-project').removeClass("active");
        elm.addClass("active");
        $('#v-pills-tab').empty();
        
        var url = "/api?id=tables&project=" + elm.data("project");
        $.getJSON(url, function(data) {
          $.each(data["response"], function(i, k) {
            $('#v-pills-tab').append("<a data-table-name='" + k + "' class='project-table nav-link' data-toggle='pill' href='#v-pills-content' role='tab'>" + k + "</a>");
          });
          $('#v-pills-tab').append("<a data-table-name='files' class='project-table nav-link' data-toggle='pill' href='#v-pills-content' role='tab'>Files</a>");
          setupTableClickHandlers();
        });
      });
    }
    
    function setupTableClickHandlers() {
      $('.project-table').click(function() {
        var elm = $(this);
        var project = $('.dog-project.active').data("project");
        var url = "/api?id=contents&project=" + project + "&table=" + elm.data("table-name");
        $.getJSON(url, function(data) {
          $("#table-items").empty();
          $.each(data["response"], function(i, k) {
            $("#table-items").append("<li>" + k + "</li>")
          });
        });
      });
    }
  </script>
</body>
</html>
